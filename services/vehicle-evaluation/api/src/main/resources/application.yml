# GestAuto - Vehicle Evaluation Service
spring:
  application:
    name: vehicle-evaluation

  profiles:
    active: default

  # OAuth2 Resource Server - Keycloak
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/gestauto
          jwk-set-uri: http://localhost:8080/realms/gestauto/protocol/openid-connect/certs

  # Database Configuration
  datasource:
    url: jdbc:postgresql://localhost:5432/gestauto?currentSchema=vehicle_evaluation
    username: gestauto
    password: gestauto123
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      max-lifetime: 600000
      connection-timeout: 30000

  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        use_sql_comments: true
        default_schema: vehicle_evaluation
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # Flyway Configuration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    baseline-version: 1
    schemas: vehicle_evaluation
    url: jdbc:postgresql://localhost:5432/gestauto
    user: gestauto
    password: gestauto123

  # RabbitMQ Configuration
  rabbitmq:
    host: localhost
    port: 5672
    username: gestauto
    password: gestauto123
    virtual-host: /
    connection-timeout: 15000
    publisher-confirm-type: correlated
    publisher-returns: true
    listener:
      simple:
        acknowledge-mode: manual
        retry:
          enabled: true
          initial-interval: 1000
          max-attempts: 3
          max-interval: 10000
          multiplier: 2

# Configurações customizadas do RabbitMQ
rabbitmq:
  exchange:
    name: gestauto.events
  queue:
    vehicle-evaluation: vehicle-evaluation.events
    vehicle-evaluation.dlq: vehicle-evaluation.events.dlq
  routing-key:
    vehicle-evaluation: vehicle.evaluation.*

  # Redis Configuration
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

  # Cache Configuration
  cache:
    type: redis
    redis:
      time-to-live: 86400000 # 24 horas em milissegundos

  # Jackson Configuration
  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      fail-on-empty-beans: false
    deserialization:
      fail-on-unknown-properties: false

  # File Upload Configuration
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

# Server Configuration
server:
  port: 8081
  servlet:
    context-path: /api
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain

# Management & Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
  info:
    env:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    instances:
      fipe-api:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 3
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        slowCallRateThreshold: 100
        slowCallDurationThreshold: 5000
        recordExceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException
          - java.net.ConnectException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:
          - com.gestauto.vehicleevaluation.infra.client.fipe.FipeApiException

  retry:
    instances:
      fipe-api:
        registerHealthIndicator: false
        maxAttempts: 3
        waitDuration: 1000
        retryExceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException.ServiceUnavailable
          - java.net.ConnectException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:
          - org.springframework.web.reactive.function.client.WebClientResponseException.BadRequest

  timelimiter:
    instances:
      fipe-api:
        timeoutDuration: 5s
        cancelRunningFuture: true

# External APIs Configuration
app:
  external-apis:
    fipe:
      base-url: https://parallelum.com.br/fipe/api/v1
      timeout: 5
      connect-timeout: 2000
      retry-attempts: 3
      retry-delay: 1000
      rate-limit-per-minute: 100
      circuit-breaker:
        failure-threshold: 50
        wait-duration: 30
        sliding-window: 10

    cloudflare-r2:
      endpoint: ${CLOUDFLARE_R2_ENDPOINT:https://your-account.r2.cloudflarestorage.com}
      access-key: ${CLOUDFLARE_R2_ACCESS_KEY:}
      secret-key: ${CLOUDFLARE_R2_SECRET_KEY:}
      bucket-name: ${CLOUDFLARE_R2_BUCKET:vehicle-evaluation-photos}
      public-url: ${CLOUDFLARE_R2_PUBLIC_URL:https://your-account.r2.dev}
      timeout: 10
      part-size: 5242880
      max-connections: 50

# Logging Configuration
logging:
  level:
    com.gestauto.vehicleevaluation: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# OpenAPI Documentation
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operationsSorter: method
  override-with-generic-response: false
  show-actuator: true

# Custom Application Properties
app:
  base-url: ${APP_BASE_URL:http://localhost:8080}
  
  # PDF Generation Configuration
  pdf:
    max-image-size-mb: ${PDF_MAX_IMAGE_SIZE_MB:5}
    max-total-images-size-mb: ${PDF_MAX_TOTAL_IMAGES_SIZE_MB:50}

gestauto:
  vehicle-evaluation:
    # FIPE API Configuration
    fipe:
      base-url: https://parallelum.com.br/fipe/api/v1/
      cache-ttl: 86400000 # 24 horas

    # Cloudflare R2 Configuration
    cloudflare-r2:
      endpoint: ${CLOUDFLARE_R2_ENDPOINT:https://your-account.r2.cloudflarestorage.com}
      bucket: ${CLOUDFLARE_R2_BUCKET:vehicle-evaluation-photos}
      access-key: ${CLOUDFLARE_R2_ACCESS_KEY:}
      secret-key: ${CLOUDFLARE_R2_SECRET_KEY:}

    # Evaluation Configuration
    evaluation:
      default-validity-hours: 72
      max-photos-per-evaluation: 15
      max-photo-size-mb: 10

    # PDF Report Configuration
    report:
      template-path: classpath:templates/reports/
      logo-path: classpath:static/images/logo.png

    # JWT Configuration
    jwt:
      secret: ${JWT_SECRET:vehicle-evaluation-secret-key-change-in-production}
      expiration: 86400000 # 24 horas

    # RabbitMQ Events
    events:
      evaluation-completed:
        exchange: gestauto.events
        routing-key: vehicle.evaluation.completed
      evaluation-approved:
        exchange: gestauto.events
        routing-key: vehicle.evaluation.approved
      evaluation-rejected:
        exchange: gestauto.events
        routing-key: vehicle.evaluation.rejected

---
# Development Profile
spring:
  config:
    activate:
      on-profile: dev

app:
  base-url: ${APP_BASE_URL:http://localhost:8080}

logging:
  level:
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    com.gestauto.vehicleevaluation: DEBUG

gestauto:
  vehicle-evaluation:
    # Development overrides
    jwt:
      expiration: 864000000 # 10 dias para desenvolvimento

---
# Docker Profile
spring:
  config:
    activate:
      on-profile: docker

  datasource:
    url: jdbc:postgresql://gestauto-postgres:5432/gestauto?currentSchema=vehicle_evaluation

  flyway:
    url: jdbc:postgresql://gestauto-postgres:5432/gestauto
    user: gestauto
    password: gestauto123

  rabbitmq:
    host: gestauto-rabbitmq

  data:
    redis:
      host: redis

cloudflare:
  r2:
    bucket-name: ${CLOUDFLARE_R2_BUCKET_NAME:gestauto-evaluations}
    public-url: ${CLOUDFLARE_R2_PUBLIC_URL:http://localhost:9000/gestauto-evaluations}
    access-key: ${CLOUDFLARE_R2_ACCESS_KEY:minioadmin}
    secret-key: ${CLOUDFLARE_R2_SECRET_KEY:minioadmin}
    endpoint: ${CLOUDFLARE_R2_ENDPOINT:http://minio:9000}

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

  jpa:
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false

app:
  base-url: ${APP_BASE_URL:https://gestauto.com}
  
  pdf:
    max-image-size-mb: ${PDF_MAX_IMAGE_SIZE_MB:3}
    max-total-images-size-mb: ${PDF_MAX_TOTAL_IMAGES_SIZE_MB:30}

logging:
  level:
    com.gestauto.vehicleevaluation: INFO
    org.springframework.security: WARN
    org.hibernate.SQL: WARN
  file:
    name: /var/log/vehicle-evaluation/application.log

management:
  endpoint:
    health:
      show-details: never
# Cloudflare R2 Configuration
cloudflare:
  r2:
    access-key: ${CLOUDFLARE_R2_ACCESS_KEY:mock-key}
    secret-key: ${CLOUDFLARE_R2_SECRET_KEY:mock-secret}
    endpoint: ${CLOUDFLARE_R2_ENDPOINT:https://mock.r2.cloudflarestorage.com}
    bucket-name: ${CLOUDFLARE_R2_BUCKET_NAME:gestauto-evaluations}
    public-url: ${CLOUDFLARE_R2_PUBLIC_URL:https://pub-mock.r2.dev}
